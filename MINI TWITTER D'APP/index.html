<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mini Twitter DApp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>
    <h1>Mini Twitter DApp</h1>
    <button id="connectWalletBtn" onclick="connectWallet()">Connect Wallet</button>
    <p id="userAddress"></p>

    <h2>Add a New Post</h2>
    <textarea id="postMessage" placeholder="What's on your mind?" maxlength="140"></textarea>
    <button onclick="addPost()">Post</button>

    <h2>Feed</h2>
    <div id="feed"></div>

    <script type="text/javascript">
        let web3;
        let contract;
        const contractAddress = '0x0DCd1Bf9A1b36cE34237eEaFef220932846BCD82';  // Replace with your deployed contract address
        const abi = [
            {
                "inputs": [
                    { "internalType": "string", "name": "_message", "type": "string" }
                ],
                "name": "publishPost",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "_postId", "type": "uint256" }
                ],
                "name": "getPost",
                "outputs": [
                    { "internalType": "string", "name": "message", "type": "string" },
                    { "internalType": "address", "name": "author", "type": "address" },
                    { "internalType": "uint256", "name": "numLikes", "type": "uint256" },
                    { "internalType": "uint256", "name": "numDislikes", "type": "uint256" },
                    { "internalType": "uint256", "name": "timestamp", "type": "uint256" },
                    { "internalType": "uint256", "name": "lastModified", "type": "uint256" }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getTotalPosts",
                "outputs": [
                    { "internalType": "uint256", "name": "", "type": "uint256" }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "_postId", "type": "uint256" }
                ],
                "name": "likePost",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "_postId", "type": "uint256" }
                ],
                "name": "dislikePost",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    { "internalType": "uint256", "name": "_postId", "type": "uint256" },
                    { "internalType": "string", "name": "_newMessage", "type": "string" }
                ],
                "name": "editPost",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        async function connectWallet() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                const account = (await web3.eth.getAccounts())[0];
                document.getElementById('userAddress').innerText = `Connected: ${account}`;
                contract = new web3.eth.Contract(abi, contractAddress);
                loadPosts();
            } else {
                alert('Please install MetaMask to use this app.');
            }
        }

        async function loadPosts() {
            try {
                const postCount = Number(await contract.methods.getTotalPosts().call());  // Convert BigInt to Number
                const feedDiv = document.getElementById('feed');
                feedDiv.innerHTML = '';  // Clear existing content
        
                const account = (await web3.eth.getAccounts())[0];
                for (let i = 0; i < postCount; i++) {
                    const post = await contract.methods.getPost(i).call();
                    const postDate = new Date(Number(post.timestamp) * 1000).toLocaleString();  // Convert BigInt timestamp
                    const modifiedDate = post.lastModified > 0 ? new Date(Number(post.lastModified) * 1000).toLocaleString() : 'Never';
        
                    const postDiv = document.createElement('div');
                    postDiv.innerHTML = `
                        <p><strong>Author:</strong> ${post.author}</p>
                        <p><strong>Message:</strong> <span id="message-${i}">${post.message}</span></p>
                        <p><strong>Likes:</strong> ${Number(post.numLikes)} <button onclick="likePost(${i})">Like</button></p>  <!-- Convert numLikes to Number -->
                        <p><strong>Dislikes:</strong> ${Number(post.numDislikes)} <button onclick="dislikePost(${i})">Dislike</button></p>  <!-- Convert numDislikes to Number -->
                        <p><strong>Posted On:</strong> ${postDate}</p>
                        <p><strong>Last Modified:</strong> ${modifiedDate}</p>
                    `;
        
                    // If the current user is the post author, add an edit option
                    if (account.toLowerCase() === post.author.toLowerCase()) {
                        postDiv.innerHTML += `
                            <textarea id="editMessage${i}" placeholder="Edit your post...">${post.message}</textarea>
                            <button onclick="editPost(${i})">Save Changes</button>
                        `;
                    }
        
                    postDiv.innerHTML += '<hr>';
                    feedDiv.appendChild(postDiv);
                }
            } catch (error) {
                console.error("Error loading posts:", error);
            }
        }

        async function addPost() {
            try {
                const message = document.getElementById('postMessage').value;
                const account = (await web3.eth.getAccounts())[0];
                await contract.methods.publishPost(message).send({ from: account });
                document.getElementById('postMessage').value = '';  // Clear input field
                loadPosts();  // Refresh the feed
            } catch (error) {
                console.error("Error adding post:", error);
            }
        }

        async function likePost(postId) {
            try {
                const account = (await web3.eth.getAccounts())[0];
                await contract.methods.likePost(postId).send({ from: account });
                loadPosts();  // Refresh the feed
            } catch (error) {
                console.error("Error liking post:", error);
            }
        }

        async function dislikePost(postId) {
            try {
                const account = (await web3.eth.getAccounts())[0];
                await contract.methods.dislikePost(postId).send({ from: account });
                loadPosts();  // Refresh the feed
            } catch (error) {
                console.error("Error disliking post:", error);
            }
        }

        async function editPost(postId) {
            try {
                const newMessage = document.getElementById(`editMessage${postId}`).value;
                const account = (await web3.eth.getAccounts())[0];
                await contract.methods.editPost(postId, newMessage).send({ from: account });
                loadPosts();  // Refresh the feed
            } catch (error) {
                console.error("Error editing post:", error);
            }
        }
    </script>
</body>
</html>
